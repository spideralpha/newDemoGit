<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title></title>
    <link rel="stylesheet" type="text/css" href="../../css/liaotian/mui.min.css" />
    <link rel="stylesheet" type="text/css" href="../../css/liaotian/app.css" />
    <link rel="stylesheet" type="text/css" href="../../css/liaotian/main.css" />
    <link rel="stylesheet" type="text/css" href="../../css/liaotian/reset.css" />
    <link rel="stylesheet" type="text/css" href="../../css/news.css">
    <link rel="stylesheet" type="text/css" href="../../css/aui_font.css">
    <link rel="stylesheet" type="text/css" href="../../css/liaotian1.css">
    <style>

    </style>
</head>

<body>
<div id="view" v-cloak>
    <div class="wanshan flex-bt" v-if="wanshan==1 && !ios">
        <div class="left">
            <p class="title">å°ç«è‹—æå€¡çœŸå®äº¤å‹</p>
            <p class="txt">å®Œå–„èµ„æ–™å³å¯è·å¾—é‡‘å¸å¥–åŠ±</p>
        </div>
        <div class="right flex">
            <button class="btn" onclick="_url({url:'frame4/user', title:'ç¼–è¾‘èµ„æ–™', moreTitle: 'ä¿å­˜'})">é¢†å–</button>
            <i class="aui-iconfont aui-icon-close" @click="wanshan=0"></i>
        </div>
    </div>
    <!-- å½•éŸ³æç¤º -->
    <div id="sound-alert" class="rprogress" v-if="record==1">
        <div class="rschedule"></div>
        <div class="r-sigh">!</div>
        <div id="audio_tips" class="rsalert">{{recordTxt}}</div>
    </div>
    <!-- åº§é©¾ -->
    <!-- <div class="car-wrap">
        <img src="../../image/more/10-32-06.png" alt="">
    </div> -->
    <!-- èŠå¤©åˆ—è¡¨ -->
    <div class="mui-content">
        <!-- <div class="tips">è¯·æ–‡æ˜èŠå¤©ï¼Œä¸¥ç¦ä½ä¿—ã€æ¶‰é»„ã€æ¬ºè¯ˆè¡Œä¸º</div> -->
        <!-- <div class="tip" onclick="_url({url:'about', id:8, title:'é˜²éª—æŒ‡å—'})"> <img src="../../image/icon/tsic@2x.png" alt=""> è¯·è°¨æ…æ·»åŠ é™Œç”Ÿäºº{{escape_w}}ã€QQç­‰è”ç³»æ–¹å¼ï¼Œè°¨é˜²ä¸Šå½“å—éª— <span>é˜²éª—æŒ‡å—<i class="aui-iconfont aui-icon-right"></i></span> </div> -->
        <div class="loadmore" v-if="loadmore==1"></div>
        <!-- ç³»ç»Ÿå¹¿æ’­ -->
        <!-- <div class="notice">
            <img class="avatar" src="../../image/touxiang.png" alt="">
            <div class="info">
                <div class="name">å¤§å¤§å–µæ˜Ÿäºº</div>
                <div class="value">å¤§å¤§å–µæ˜Ÿäºº é€ç»™ å¸ƒå¶ ä¸€ä¸ª è¶…çº§ç«ç®­ï¼ŒæŒå£°ç¥ç¦ </div>
            </div>
            <div class="djtime"><span>3S</span><img src="../../image/icon/djs.png" alt=""></div>
        </div> -->
        <div id="msg-list">
            <div class="info-box" v-if="showInput==1 && !ios && otherInfo.sex=='å¥³'">
                <ul class="info-ul" @click="goUserInfo(otherInfo.id, otherInfo.name)">
                    <li class="list">
                        <img class="info-icon" src="../../image/chat/icon_rzzt_line.png" alt="">
                        <span class="i-title">è®¤è¯çŠ¶æ€: </span>
                        <div class="info-content">
                            <span class="rz-man rz-bg" v-if="otherInfo.is_identity_authentication==2">å·²çœŸäººè®¤è¯</span>
                            <span class="rz-name rz-bg" v-if="otherInfo.realname_auth==2">å·²å®åè®¤è¯</span>
                            <span class="rz" v-if="otherInfo.is_identity_authentication!=2 && otherInfo.realname_auth!=2">é‚€è¯·å¯¹æ–¹è®¤è¯</span>
                        </div>
                    </li>
                    <li class="list">
                        <img class="info-icon" src="../../image/chat/icon_zuobiao_line.png" alt="">
                        <span class="i-title">æ‰€åœ¨åŸå¸‚: </span>
                        <div class="info-content">{{otherInfo.city}}ï¼ˆè·ç¦»{{otherInfo.distance}}ï¼‰</div>
                    </li>
                    <li class="list">
                        <img class="info-icon" src="../../image/chat/icon_ziliao_line.png" alt="">
                        <span class="i-title">åŸºæœ¬èµ„æ–™: </span>
                        <div class="info-content">
                            <span class="info-tag" v-if="otherInfo.age">{{otherInfo.age}}å²</span>
                            <span class="info-tag" style="border-color: #2196f3;" v-if="otherInfo.occupation">{{otherInfo.occupation}}</span>
                            <span class="info-tag" style="border-color: #795548;" v-if="otherInfo.stature">{{otherInfo.stature}}cm</span>
                        </div>
                    </li>
                    <li class="list" style="align-items: flex-start;">
                        <img class="info-icon" src="../../image/chat/icon_meizhao_lin.png" alt="">
                        <span class="i-title">ç¾ç…§: </span>
                        <div class="info-content flex-w">
                            <img class="info-img" @click.stop="_url({uid:otherInfo.id, iIndex:pindex, showZan:1,slide:1}, 'frame0/img_win')" v-for="(p, pindex) in otherInfo.photos" v-if="pindex<2" :src="returnImg(p)" onerror="this.src='../../image/error-img.png'" alt="">
                            <span class="add-btn">
                                    <img src="../../image/chat/icon_upload.png" alt="">
                                    <span>é‚€è¯·ä¸Šä¼ </span>
                                </span>
                        </div>
                    </li>
                </ul>
            </div>
            <!-- <div class="infobox" v-if="showInput==1 && !ios">
                <div class="info-top">äº¤å‹èµ„æ–™</div>
                <div class="head">
                    <img class="avatar" :src="returnImg(otherInfo.head_portrait)" onerror="this.src='../../image/touxiang.png'" alt="">
                    <div class="info" style="overflow: hidden;">
                        <div class="tags">
                            <span class="new-tag rz-tag" v-if="otherInfo.is_identity_authentication==2"></span>
                            <span class="boy-tag" :class="{'girl-tag':otherInfo.sex == 'å¥³'}">{{otherInfo.age}}å²</span>
                        </div>
                        <div class="description">{{otherInfo.city}} | {{otherInfo.stature}}cm | {{otherInfo.occupation}}</div>
                        <div class="sign">{{otherInfo.self_slogan}}</div>
                    </div>
                </div>
                <div class="listavatar" v-if="otherInfo.photo_show && otherInfo.photo_show.length>0">
                    <img v-for="(t, tindex) in otherInfo.photo_show" v-if="tindex < 3" :src="returnImg(t)" onerror="this.src='../../image/touxiang.png'" alt="">
                </div>
                <div class="dushu"><img src="../../image/icon/dashan1.png" alt=""><span>{{otherInfo.intimate}}Â°C</span></div>
            </div> -->
            <div class="msg-wrap" v-for="(item, index) in ffList" :id="'id'+item.id">
                <div class="time" v-if="item.showtime"><span>{{item.time}}</span></div>
                <div class="recall" v-if="item['status'] == 3"><span>è¯¥æ¶ˆæ¯å·²è¢«æ’¤å›</span></div>
                <div v-else>
                    <div class="hongbao-msg" v-if="item['type'] == -1">
                        <div v-if="item['state'] == 1 && item.data && item.data.chat_id">
                            <p v-if="item.data.userid == userid">{{otherInfo.name}}é¢†å–äº†ä½ çš„<span @click="openRedDetail(item.data.chat_id, item.data.type)">çº¢åŒ…</span></p>
                            <p v-else>ä½ é¢†å–äº†{{otherInfo.name}}çš„<span @click="openRedDetail(item.data.chat_id, item.data.type)">çº¢åŒ…</span> </p>
                        </div>
                        <div class="tip-content" v-else v-html="item.content"></div>
                    </div>
                    <li v-else :class="{'msg-item-self':item.self==1, 'red-envelope':item.type==5||item.type==7, 'money':item.type==7, 'read-burn':Number(item.is_burn)!=0, 'msg-area':(item.type==6||item.type==8||item.type==11)}" class="msg-item">
                        <div class="msg-user">
                            <img @click="goUserInfo(item.userid, item.name);" :id="item.userid" :src="returnImg(item.head_portrait)" onerror="this.src='../../image/touxiang.png'" />
                        </div>
                        <div class="msg-container">
                            <!-- <p class="user-name" v-if="qun==1">{{item.name}}</p> -->
                            <div class="msg-content" @touchstart="touchstartF(index);" @touchend="touchendF(index);">
                                <div class="msg-content-inner" style="word-break: break-word;">
                                    <div v-if="item.type==0">
                                        <div v-if="item.k==0" v-html="getMesge(item.content, item)"></div>
                                        <div class="msg-apply" v-else>
                                            <div v-html="dealContent(item)"></div>
                                            <div class="btn-wrap flex-bt" v-if="item.state!=1">
                                                <button class="btn" @click.stop @click="applyQun(index, -1)">æ‹’ç»</button>
                                                <button class="btn btn2" @click.stop @click="applyQun(index,1)">å…è®¸</button>
                                            </div>
                                            <div class="btn-wrap flex-c" v-else>
                                                <button class="btn ">å·²å¤„ç†</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div v-else-if="item.type==1">
                                        <img v-if="Number(item.is_burn)==0" @click.stop @click="_url({imgArr:[item.content], iIndex:0}, 'frame1/dy_img_win')" class="msg-content-image load" :src="returnImg(item.content)" onerror="this.src='../../image/error-img.png'" style="max-width: 100px;" />
                                        <div v-else @click="openBurn(index)" class="burn-msg" :class="{'burn':item.is_burn==-1}"></div>
                                    </div>
                                    <div v-else-if="item.type==2" @click.stop @click="audioPlay(index)">
                                            <span class="play-state" style="margin-top:3px;">
                                                <span class="audio" :class="{'aplaying':audio.id==item.id && audio.play==1}"></span>
                                            </span>
                                    </div>
                                    <div v-else-if="item.type==3" class="msg-video" @click="openVideo(index)">
                                        <img :src="returnImg(item.data.cover)" onerror="this.src='../../image/error-img.png'" alt="">
                                        <!-- <img src="../../image/shop/01.jpg" alt=""> -->
                                        <i class="video-icon"></i>
                                    </div>
                                    <div class="red-wrap" @click.stop @click="openRed(index)" v-else-if="item.type==5||item.type==7">
                                        <div class="red-img" :class="{'red-img-no':item.state==1}"></div>
                                        <div class="game">
                                            <p class="red-game-text">{{item.content}}</p>
                                            <p class="red-game" v-if="item.state==0">ç­‰å¾…é¢†å–</p>
                                            <p class="red-game" v-else-if="item.state==1">å·²é¢†å–</p>
                                            <p class="red-game" v-else-if="item.state==2">å·²è¿‡æœŸ</p>
                                        </div>
                                    </div>
                                    <div class="msg-video" v-else-if="item.type==6" @click="openArea(index)">
                                        <img src="../../image/icon/nim_location_bk.png" alt="">
                                    </div>
                                    <img v-else-if="item.type==8" @click="showDetail('modal/send_gift', {data:item.data, touid :touserid, fa:item.userid})" class="msg-content-image load" :src="returnImg(item.data.cover)" onerror="this.src='../../image/error-img.png'" style="max-width: 150px;" />
                                    <img v-else-if="item.type==11" class="msg-content-image load" :src="returnImg(item.data.image)" onerror="this.src='../../image/error-img.png'" style="max-width: 50px;" />
                                    <div v-else-if="item.type==9 || item.type==10" class="msg-voice">
                                        <i class="msg-voice-icon" :class="{'msg-voice-icon2':item.type==10}"></i>
                                        <span v-if="!item.chat_time">{{item.content}}</span>
                                        <span v-else>é€šè¯æ—¶é•¿ {{item.chat_time}}</span>
                                        <!-- <span>{{item.content}}</span> -->
                                    </div>
                                </div>
                                <div class="msg-content-arrow"></div>
                            </div>
                            <p class="price" :class="{'getting': item.finish==1}" v-if="item.self!=1 && Number(item.score) && !ios">+{{item.score}}ç§¯åˆ†</p>
                        </div>
                        <div class="timeSec" v-if="item.type!=9 && item.type!=10 && item.type!=8 && item.type!=11">
                            <div v-if="item.self == 1" style="line-height:50px;float:right;font-size:14px;color:#999;">
                                <span v-if="item.type==2">{{item.second}}s"</span>
                                <span class="read-status ready-read" v-if="item.isRead==1">å·²è¯»</span>
                                <span class="read-status" v-else>æœªè¯»</span>
                            </div>
                            <div v-else style="line-height:50px;font-size:14px;color:#999;">
                                <span v-if="item.type==2">{{item.second}}s"</span>
                            </div>
                        </div>
                        <div class="timeSec" v-if="item.type==8 || item.type==11">
                            <div v-if="item.self == 1" style="line-height:50px;float:right;font-size:14px;color:#999;">
                                <span class="read-status ready-read" v-if="item.isRead==1">{{item.data.name}}x{{item.data.num}}</span>
                                <span class="read-status" v-else>{{item.data.name}}x{{item.data.num}}</span>
                            </div>
                            <div v-else style="line-height:50px;font-size:14px;color:#999;">
                                <span class="read-status ready-read" v-if="item.isRead==1">{{item.data.name}}x{{item.data.num}}</span>
                                <span class="read-status" v-else>{{item.data.name}}x{{item.data.num}}</span>
                            </div>
                        </div>
                        <div class="mui-item-clear"></div>
                    </li>
                </div>
            </div>
            <div id="msg-bottom"></div>
        </div>
    </div>
    <footer v-if="showInput==1">
        <div class="quick-word" v-if="cyyList.length>0">
            <span v-for="(m, index) in cyyList" v-if="index<5" @click.stop="sendmsg(m.content)">{{returnQ(m.content)}}</span>
            <!-- <span>è¿™æ˜¯å¿«æ·è¯­è¿™æ˜¯å¿«æ·è¯­è¿™æ˜¯å¿«æ·è¯­è¿™æ˜¯å¿«æ·è¯­</span>
            <span>è¿™æ˜¯å¿«æ·è¯­è¿™æ˜¯å¿«æ·è¯­</span> -->
        </div>
        <div class="footer">
            <div class="input">
                <!-- å½•éŸ³é”® -->
                <img class="tool-img" @click="clickRecord(0)" v-if="recordBtn==1" src="../../image/chat/chat_voice_icon_n.png" alt="">
                <img class="tool-img" @click="clickRecord(1)" v-else src="../../image/chat/chat_keyboard_icon_n.png" alt="">
                <!-- å½•éŸ³æ—¶è¾“å…¥æ¡†ç¦æ­¢çŠ¶æ€ -->
                <div class="input-wrap" :class="{'new-hide':recordBtn==1}">
                    <div id="js-input2" style="width: 100%;" contenteditable="false" class="css-input" @touchstart="recordBegin($event);" @touchmove="recordCancel($event);" @touchend="recordEnd($event);">{{recordBtnTxt}}</div>
                </div>
                <!-- è¾“å…¥æ¡† -->
                <div class="input-wrap" :class="{'new-hide':recordBtn==0}">
                    <div id="js-input" class="css-input" contenteditable="true" @click="inputClick()" @input="handleSelection"></div>
                    <span style="height: 25px;" onclick="uiboxClick('å¸¸ç”¨è¯­')"><img style="width: 30px;" src="../../image/chat/more.png" alt=""></span>
                </div>
                <!-- <img class="tool-img" v-if="recordEmo==1" @click="clickEmo(0)" src="../../image/icon/face.png" alt="">
                <img class="tool-img" v-else @click="clickEmo(1)" src="../../image/chat/chat_keyboard_icon_n.png" alt=""> -->
                <!-- <img class="tool-img" src="../../image/icon/gift.png" alt=""> -->
                <button class="send-btn" onclick="sendTxt()">å‘é€</button>
            </div>
            <!-- èŠå¤©æ“ä½œ -->
            <div class="moreoptions">
                <!-- <div class="op" onclick="dashan()"><img src="../../image/icon/hi.png" alt=""></div> -->
                <div class="op" onclick="selectPicType()"><img src="../../image/chat/chat_picture_icon_n.png" alt=""></div>
                <!-- è¯­éŸ³ï¼Œè§†é¢‘èŠå¤©å›¾æ ‡æŒ‰é’® -->
                <div class="op" v-if="show_video_voice" @click="openChat()"><img src="../../image/chat/chat_call_icon_n.png" alt=""></div>
                <div class="op" v-if="!ios" onclick="showDetail('modal/gift_modal',{uid: view.touserid})"><img src="../../image/chat/chat_gift_icon_n.png" alt=""></div>
                <div class="op" v-if="recordEmo==1" @click="clickEmo(0)"><img src="../../image/chat/chat_expression_icon_h.png" alt=""> </div>
                <div class="op" v-else @click="clickEmo(1)"><img src="../../image/chat/chat_expression_icon_n.png" alt=""> </div>

<!--                <div class="op" v-if="extra==0" @click="clickExtra(1)"><img src="../../image/chat/chat_add_icon_n.png" alt=""></div>-->
<!--                <div class="op" v-else @click="clickExtra(0)"><img src="../../image/chat/chat_add_icon_h.png" alt=""></div>-->
            </div>
            <!-- è¡¨æƒ… -->
            <div class="emo-wrap" :class="{'new-hide':recordEmo!=0}">
                <img v-for="(m, index) in emotionArr" :src="'../../res/img/emotion/'+m.name+'.png'" alt="" @click="handleTag(m.name)">
                <!-- <img class="del-btn" src="../../res/img/emotion/delete.png" alt="" @click="delEmo()"> -->
            </div>
            <!-- é™„åŠ é¢æ¿ -->
<!--            <ul class="extra-wrap flex-w" :class="{'new-hide':extra!=0}">-->
<!--                <li class="list" onclick="selectPicType()">-->
<!--                    <img src="../../image/chat/chat_add_picture_icon_n.png" alt="">-->
<!--                    <p>å›¾ç‰‡</p>-->
<!--                </li>-->
<!--                <li class="list" onclick="uiboxClick('è§†é¢‘')">-->
<!--                    <img src="../../image/chat/chat_add_video_icon_n.png" alt="">-->
<!--                    <p>å°è§†é¢‘</p>-->
<!--                </li>-->
                <!-- <li class="list" onclick="uiboxClick('ä½ç½®')">
                    <img src="../../image/chat/chat_add_position_icon_n.png" alt="">
                    <p>ä½ç½®</p>
                </li> -->
<!--            </ul>-->
        </div>
    </footer>
</div>
</body>
<script src="../../script/api.js"></script>
<script src="../../script/jquery.js"></script>
<script src="../../script/emotion.js"></script>
<script src="../../script/ffkj.js"></script>
<script src="../../script/liaotian.js"></script>
<script src="../../script/map.js"></script>
<script src="../../script/audio.js"></script>
<script src="../../script/uibutton.js"></script>
<script src="../../script/limitchat.js"></script>
<script src="../../script/vue.js"></script>
<script src="../../script/input.js"></script>
<script src="../../json/liaotian.js"></script>
<script src="../../json/user.js"></script>

<script type="text/javascript" charset="utf-8">
    heigutgao = 1; // é»˜è®¤å…è®¸åŠ è½½
    pagenum = 0;
    var view = new Vue({
        el: '#view',
        data: {
            imgurl: imgurl,
            // ffList: retJson.result,
            ffList: [],
            ffInfo: {},
            ios: 1, // 1ä¸Šæ¶ 0éä¸Šæ¶
            userid: 0,
            userInfo: {}, // æˆ‘çš„
            touserid: 0,
            otherInfo: {}, // å¯¹æ–¹çš„
            info: {}, // é™„åŠ ä¿¡æ¯
            loadmore: 0, // 1åŠ è½½ä¸­ 0éšè—
            panelHeight: 0, // é¢æ¿é«˜åº¦
            inputBarHeight: 0, // è¾“å…¥æ¡†é«˜åº¦
            panStatus: 0, // é¢æ¿æ˜¯å¦æœ‰å¼€å¯
            panNum: { // ç»Ÿè®¡æ¬¡æ•°
                input: 0, // é¢æ¿é«˜åº¦å˜åŒ–çš„æ¬¡æ•°
                ext: 0, // æ§ä»¶é¢æ¿æ˜¯ç¬¬å‡ æ¬¡æ‰“å¼€
                emo: 0, // è¡¨æƒ…é¢æ¿æ˜¯ç¬¬å‡ æ¬¡æ‰“å¼€
            },
            nowH: 0, // å½“å‰åˆ—è¡¨çš„é«˜åº¦
            isKeFu: 0, // æ˜¯å¦ä¸ºå®¢æœ
            audio: {
                id: 0, // æ¶ˆæ¯id
                play: 0 // çŠ¶æ€ 1æ’­æ”¾ 0æœªæ’­æ”¾
            },
            recordPoi: { // è®°å½•æŒ‰ä¸‹çš„ä½ç½® é¿å…è½»å¾®ç§»åŠ¨å¯¼è‡´å½•éŸ³å¤±è´¥
                x: 0,
                y: 0
            },
            recordBtnTxt: 'æŒ‰ä½è¯´è¯',
            recordBtn: 1, // å½•éŸ³æŒ‰é’®æ˜¯å¦æ˜¾ç¤º 1æ˜¾ç¤º(å³ä¸ºéå½•éŸ³çŠ¶æ€) 0éšè—(åˆ‡æ¢ä¸ºå¯å½•éŸ³çŠ¶æ€)
            record: 0, // 1 å½•éŸ³ä¸­ 0æœªå½•éŸ³
            recordTxt: 'æ‰‹æŒ‡ä¸Šåˆ’ï¼Œå–æ¶ˆå‘é€', // å½•éŸ³æç¤ºæ–‡æœ¬
            frameH: 0, // frame åŸå§‹é«˜åº¦

            extra: 1, // é™„åŠ é¢æ¿ 1éšè— 0æ˜¾ç¤º
            // è¡¨æƒ…è¾“å…¥
            selection: '',
            range: '',
            textNode: '',
            rangeStartOffset: '',
            recordEmo: 1, // è¡¨æƒ…é¢æ¿ 1éšè— 0æ˜¾ç¤º

            inputContent: '',

            showInput: 0, // æ˜¯å¦æ˜¾ç¤ºè‡ªå®šä¹‰è¾“å…¥æ¡† 1æ˜¾ç¤º 0ä¸æ˜¾ç¤º

            emotionArr: emotionUrl,

            inputLimit: 1, // æ˜¯å¦å…è®¸è¾“å…¥ 1å…è®¸ 0ç¦æ­¢

            isResume: 1, // æ˜¯å¦åˆ‡æ¢ä¸ºå‰å°

            cyyList: [], // å¸¸ç”¨è¯­åˆ—è¡¨

            wanshan: 0,

            config: {}, // ç³»ç»Ÿé…ç½®
            scroll: 0,
            show_video_voice: 1
        },
        methods: {
            // å†…å®¹å¤„ç†
            dealContent(m) {
                var name = m.data.apply_name;
                var id = m.data.apply_user;
                var c = m.content.replace(`${name}(${id})`, `<a onclick="go_userInfo(${id}, '${name}')">${name}(${id})</a>`)
                return c;
            },
            // å¿«æ·è¯­å¤„ç†
            returnQ(s) {
                if (s && s.length > 10) {
                    s = s.substring(0, 10);
                    s += '...';
                }
                return s;
            },
            // å‘é€å¸¸ç”¨è¯­
            sendmsg(msg) {
                var data = {
                    type: 0,
                    content: msg,
                }
                sendMsg(data)
            },
            // æ—¶é—´å¤„ç†
            returnTime(time) {
                return returnTime(time * 60);
            },
            // è¾“å…¥æ¡†ç‚¹å‡»
            inputClick() {
                handleSelection();
                view.recordEmo = 1;
                view.extra = 1;
            },
            handleTag(imgname) {
                handleTag(imgname);
            },
            // è®°å½•å…‰æ ‡ä½ç½®ç­‰ ï¼ˆdebounceé˜²æŠ–æå‡æ€§èƒ½ï¼‰
            handleSelection() {
                handleSelection()
            },
            // ç‚¹å‡»è¡¨æƒ…æŒ‰é’®
            clickEmo(type) {
                view.recordBtn = 1;
                view.recordEmo = type;
                view.extra = 1;
            },
            // ç‚¹å‡»é™„åŠ é¢æ¿
            clickExtra(type) {
                view.recordBtn = 1;
                view.recordEmo = 1;
                view.extra = type;
            },
            // ç‚¹å‡»å½•éŸ³æŒ‰é’®
            clickRecord(type) {
                view.recordEmo = 1;
                view.extra = 1;
                view.recordBtn = type;
            },
            // å¼€å§‹å½•éŸ³
            recordBegin(e) {
                var x = e.changedTouches[0].pageX;
                var y = e.changedTouches[0].pageY;
                view.recordPoi = {
                    x: x,
                    y: y
                }
                // console.log('===å¼€å§‹====ï¼šx=' + x + ',' + 'y=' + y);
                recordBegin();
            },
            // å½•éŸ³å–æ¶ˆ
            recordCancel(e) {
                var x = e.changedTouches[0].pageX;
                var y = e.changedTouches[0].pageY;
                if (Math.abs(y - view.recordPoi.y) < 50) return;
                // console.log('===å–æ¶ˆ====ï¼šx=' + x + ',' + 'y=' + y);
                recordCancel();
            },
            // å½•éŸ³ç»“æŸ
            recordEnd(e) {
                recordEnd()
            },
            changeText() {
                var content = $.trim($('#js-input').html());
                view.inputContent = content;
            },
            openChat() {
                var min = view.config.intimate_min;
                var open = view.info.intimate - min >= 0;
                var voiceTime = view.userInfo.free_voice;
                var videoTime = view.userInfo.free_video

                var voiceBtn = 'è¯­éŸ³é€šè¯ğŸ”’';
                if (voiceTime > 0 || open) {
                    voiceBtn = 'è¯­éŸ³é€šè¯';
                }
                var videoBtn = 'è§†é¢‘é€šè¯ğŸ”’';
                if (videoTime > 0 || open) {
                    videoBtn = 'è§†é¢‘é€šè¯';
                }

                var buttons = [voiceBtn, videoBtn];
                _action('', buttons, function(bIndex) {
                    if (bIndex != 3) {
                        if (bIndex == 1) {
                            if (voiceTime > 0) {
                                _alert('æœ¬æ¬¡è¯­éŸ³å¯äº«å…è´¹é€šè¯' + voiceTime + 'åˆ†é’Ÿ', function() {
                                    view.openLM(1);
                                })
                            } else if (open) {
                                view.openLM();
                            } else {
                                _msg('äº²å¯†åº¦è¾¾åˆ°' + min + 'Â°Cæ‰èƒ½è§£é”è¯¥åŠŸèƒ½')
                            }
                        } else if (bIndex == 2) {
                            if (videoTime > 0) {
                                _alert('æœ¬æ¬¡è§†é¢‘å¯äº«å…è´¹é€šè¯' + videoTime + 'åˆ†é’Ÿ', function() {
                                    view.openVideoChat(1);
                                })
                            } else if (open) {
                                view.openVideoChat();
                            } else {
                                _msg('äº²å¯†åº¦è¾¾åˆ°' + min + 'Â°Cæ‰èƒ½è§£é”è¯¥åŠŸèƒ½')
                            }

                        }
                    }
                })
            },
            // è§†é¢‘
            openVideoChat(type) {
                openVideoChat(view.touserid, 'frame0/liaotian_win', type)
            },
            // è¿éº¦
            openLM(type) {
                openLM(view.touserid, 'frame0/liaotian_win', type)
            },
            // ç”³è¯·
            applyQun(index, status) {
                var _this = this;
                var data = _this.ffList[index].data;

                var url = _this.ffList[index].k == 1 ? 'check' : 'checkIdentity'; // å…¥ä¼š | èº«ä»½
                url = 'api/family/' + url;
                _ajax(url, function(ret, err) {
                    _msg(ret.msg);
                    if (ret && ret.code == 200) {
                        _this.ffList[index].state = 1;
                        pushMsg(data.apply_id);
                    }
                }, {
                    id: data.apply_id,
                    user_id: $api.getStorage('userid'),
                    status: status
                })
            },
            touchstartF(index) {
                // var e = event.currentTarget;
                touchstartF(index);
            },
            touchendF(index) {
                // var e = event.currentTarget;
                touchendF(index);
            },
            getMesge(s, data) {
                var str = getMesge(s);
                if (data && data.data && data.data.cluster_id && data.data.cluster_name) {
                    var id = data.data.cluster_id;
                    var name = data.data.cluster_name;
                    var btn = 'ç‚¹å‡»ç”³è¯·åŠ å…¥';
                    str = str.replace(name, `<a onclick="openQun(${id},'${name}')">${name}</a>`);
                    str = str.replace(btn, `<a onclick="openQun(${id},'${name}')">${btn}</a>`);
                }
                return str;
            },
            _url(param, url) {
                _url(param, url);
            },
            showDetail(url, data, topH, footerH) {
                showDetail(url, data, topH, footerH)
            },
            // æ‰“å¼€éŸ³é¢‘
            audioPlay(index) {
                var _this = this;
                var data = _this.ffList[index];
                if (_this.audio.id == data.id) {
                    _this.audio.play = _this.audio.play == 0 ? 1 : 0;
                } else {
                    _this.audio.id = data.id;
                    _this.audio.play = 1;
                }
                if (_this.audio.play == 1) {
                    audio.play({
                        url: returnImg(data.content)
                    })
                    setTimeout(function() {
                        _this.audio.play = 0;
                        audio.stop();
                    }, data.second * 1000)
                } else {
                    audio.stop();
                }
            },
            // æ‰“å¼€çº¢åŒ…è¯¦æƒ…
            openRed(index) {
                openRed(index)
            },
            // æ‰“å¼€çº¢åŒ…è¯¦æƒ…
            openRedDetail(id, type) {
                if (type == 5) {
                    // å¹³å°å¸
                    _url({
                        id: id
                    }, 'frame0/hong_bao_detail');
                } else {
                    // ç°é‡‘
                    _url({
                        id: id
                    }, 'frame0/money_detail');
                }
            },
            // è·³è½¬ æŸ¥çœ‹ç”¨æˆ·è¯¦æƒ…
            goUserInfo(id, name) {
                if (view.isKeFu == 1 && id == view.touserid) return;
                go_userInfo(id, name)
            },
            // æ‰“å¼€é˜…åå³ç„šçš„è¯¦æƒ…
            openBurn(index) {
                openBurn(index);
            },
            // æ‰“å¼€è§†é¢‘
            openVideo(index) {
                openVideo(index)
            },
            // æ‰“å¼€åœ°å€
            openArea(index) {
                openArea(index)
            },
            // å›¾ç‰‡
            returnImg(url) {
                return returnImg(url);
            },
        }
    })
    var recMp3, map, audio;
    apiready = function() {

        view.config = $api.getStorage('config');

        view.frameH = api.frameHeight;
        // $api.fixTabBar($api.dom('footer'));
        view.ios = $api.getStorage('shang');
        view.userid = $api.getStorage('userid');
        view.touserid = api.pageParam['touserid'];

        // è¯­éŸ³è§†é¢‘æ˜¯å¦éšè—
        view.show_video_voice = $api.getStorage('hide_video_voice') == 0;

        view.panelHeight = api.safeArea.bottom;
        if (api.pageParam['info']) {
            view.otherInfo = api.pageParam['info'].another;
            view.userInfo = api.pageParam['info'].self;
            view.info = api.pageParam['info'].data;
            view.isKeFu = view.info.kefu;

            if (view.isKeFu == 1) {
                // var btnObj = returnButton(['å›¾ç‰‡', 'è§†é¢‘']);
                view.showInput = 0;
                // editor(btnObj);
            } else {
                view.showInput = 1;
                getCyy();
                // éå®¢æœæ‰æé†’
                view.wanshan = $api.getStorage('ws_rw');
            }
        }
        // å½“å‰åº”ç”¨è¿›å…¥å‰å°ã€‚
        _listener('resume', function() {
            view.isResume = 1;
            setRead();
        })
        // å½“å‰åº”ç”¨é€€å…¥åˆ°åå°ã€‚
        _listener('pause', function() {
            view.isResume = 0;
        })
        // æ¸…ç©ºèŠå¤©è®°å½•
        _listener('clearMsg', function(ret) {
            if (ret.value.uid == view.touserid) {
                view.ffList = [];
            }
        })

        // åŠ è½½æ¶ˆæ¯åˆ—è¡¨
        getMsgList(0);
        _listener('viewappear', function() {
            view.isResume = 1;
            setRead();
            getChatInfo();
        })
        _listener('viewdisappear', function() {
            view.isResume = 0;
        })

        // ç›‘å¬é¢†å–æƒ…å†µ
        _listener('updateHB', function(ret) {
            var result = ret.value;
            updateHongbao(result.id, result.state)
        })

        // æ–°æ¶ˆæ¯
        _listener('newmsg', function(ret) {
            var data = ret.value.data;
            showChat(data);
        })
        // æ¶ˆæ¯æ•°é‡å˜åŒ–
        _listener('changeread', function(ret) {
            var data = ret.value.result;
            if (data.touserid == view.touserid) {
                // æ¶ˆæ¯å·²è¢«å¯¹æ–¹è¯»å–
                updateMsg();
            }
        })
        // é˜…åå³ç„š
        _listener('chat_burnImg', function(ret) {
            var data = ret.value.result;
            updateBurn(data);
        })

        recMp3 = api.require('recMp3');
        map = new Map();
        audio = new Audio();

        // // ç›‘å¬iosé”®ç›˜å¼¹èµ·å
        // _listener('keyboardshow', function (ret) {
        //     console.log(JSON.stringify(ret));
        //     var h = view.frameH - ret.h;
        //     changeFH(h);
        // })
        // // ç›‘å¬iosé”®ç›˜æ”¶èµ·å
        // _listener('keyboardhide', function (ret) {
        //     changeFH(view.frameH);
        // })

    }

    setTimeout(function() {
        $('#msg-list').scroll(function() {
            var $msg = $('#msg-list');
            var liaoH = $msg[0].scrollHeight; // å®é™…é«˜åº¦
            var viewH = $msg.height(); // æ˜¾ç¤ºçš„é«˜åº¦
            var toTop = $msg.scrollTop(); // æ»šåŠ¨æ¡ç§»åŠ¨çš„è·ç¦»
            if (view.scroll == 1) return;
            if (toTop < 20) {
                if (heigutgao == 1) {
                    view.scroll = 1;
                    pagenum++;
                    getMsgList(pagenum);
                }
            }
        })
    }, 1000)

    // è·å–ç§èŠèµ„æ–™
    function getChatInfo() {
        _ajax('api/privatechat/detail', function(ret, err) {
            if (ret && ret.code == 200 && ret.data) {
                var dd = ret.data;
                view.otherInfo = dd.another;
                view.userInfo = dd.self;
                view.info = dd.data;
                api.execScript({
                    script: 'changeScore(' + view.info.intimate + ')'
                })
            }
        }, {
            user_id: $api.getStorage('userid'),
            to_user: view.touserid
        })
    }

    // æ¸²æŸ“æ–°æ¶ˆæ¯
    function showChat(data) {
        var userid = view.userid;
        var touserid = view.touserid;

        var useObj = data.users;
        // å¯¹æ–¹æ—¢ä¸æ˜¯å‘é€è€…ä¹Ÿä¸æ˜¯æ¥æ”¶è€… åˆ™ä¸æ¸²æŸ“
        if (useObj.userid != touserid && useObj.touserid != touserid) return;
        var dn = data.new;
        console.log(JSON.stringify(dn))
        if (dn && dn.length > 0) {
            if (useObj.userid == view.myuserid && view.userInfo.free_chat > 0 && !view.isKeFu) {
                view.userInfo.free_chat--;
                // å…è´¹æ¬¡æ•°ç”¨å®Œ
                if (view.userInfo.free_chat == 0) {
                    view.ffList = view.ffList.concat(chatNotice([{
                        key: 'limit',
                    }]))
                }
            }
            view.ffList = view.ffList.concat(dn);
            // view.ffList = rets.data.new.concat(view.ffList);
            setRead();

            // äº²å¯†åº¦è¶…è¿‡é™å®šå€¼
            if (view.info.intimate < view.config.intimate_min && useObj.intimate >= view.config.intimate_min && !view.isKeFu) {
                view.ffList = view.ffList.concat(chatNotice([{
                    key: 'score',
                    val: useObj.intimate
                }]))
            }
            if (view.otherInfo.chat_price > 0 && view.info.intimate < 300 && useObj.intimate >= 300 && !view.isKeFu) {
                view.ffList = view.ffList.concat(chatNotice([{
                    key: 'gz',
                    val: view.otherInfo.chat_price
                }]))
            }
            view.info.intimate = useObj.intimate;
            api.execScript({
                script: 'changeScore(' + useObj.intimate + ')'
            })
        }
        if (data.recall && data.recall.length > 0) {
            for (var i = 0, len = data.recall.length; i < len; i++) {
                recallCss(data.recall[i]);
            }
        }
        goBottom();
    }


    // è·å–å¸¸ç”¨è¯­
    function getCyy() {
        _ajax('api/Privatechat/commonWords', function(ret, err) {
            if (ret && ret.code == 200) {
                view.cyyList = ret.data.splice(0, 5);
                console.log(JSON.stringify(view.cyyList))
            }
        }, {
            user_id: $api.getStorage('userid'),
            channel: 2, // 1è¯­éŸ³|2æ–‡å­—
        })
    }
    $(window).on('resize', function() {
        goBottom();
    })
    $('#js-input').on('click', function() {
        $('#js-input').focus();
    })

    // å‘é€
    function sendTxt() {
        var content = $('#js-input').html();
        content = replaceEmotion(content);
        content = clearHtml(content);
        content = htmlRestore(content);
        if (!$api.trim(content)) {
            _msg('å†…å®¹ä¸èƒ½ä¸ºç©º');
            return
        }
        $('#js-input').html('');
        sendMsg({
            type: 0,
            content: content,
        })
    }

    // ä¿®æ”¹frameé«˜åº¦
    function changeFH(h) {
        api.setFrameAttr({
            name: api.frameName,
            rect: {
                h: h
            }
        });
    }



    // åŠ è½½ä¸Šä¸€é¡µ
    function getMsgList(page) {
        view.loadmore = 1;
        view.nowH = $('#msg-list').height();
        _ajax('home/Privatechat/getMsgList', function(ret, err) {
            console.log(JSON.stringify(ret))
            console.log(JSON.stringify(err))
            if (ret.code == 200) {
                if (ret.result && ret.result.length > 0) {
                    view.scroll = 0;
                }
                view.ffList = ret.result.concat(view.ffList);
            } else if (ret.code == 201) {
                heigutgao = 0;
            }
            view.loadmore = 0;
            if (page == 0) {
                if (!view.isKeFu) {
                    var arr = [{
                        key: 'pian'
                    }];
                    if (view.otherInfo.is_identity_authentication != 2) {
                        arr.push({
                            key: 'rz'
                        })
                    }
                    view.ffList = view.ffList.concat(chatNotice(arr));
                }
                setTimeout(function() {
                    goBottom();
                }, 400)
            }
        }, {
            userid: view.userid,
            touserid: view.touserid,
            page: page,
        })
    }

    // æ›´å¤šæ“ä½œ
    function _more() {
        if (view.isKeFu == 1) return;
        var gzTxt = view.info.attention == 0 ? 'å…³æ³¨' : 'å–æ¶ˆå…³æ³¨';
        var lhTxt = view.info.blacklist == 1 ? 'ç§»å‡ºé»‘åå•' : 'æ‹‰é»‘';
        var buttons = ['æŸ¥çœ‹èµ„æ–™', gzTxt, 'ä¸¾æŠ¥', lhTxt];
        var keyArr = [3, 4, 5, 6]
        // var buttons = ['æ·»åŠ å¤‡æ³¨å', 'æ¶ˆæ¯ç½®é¡¶', 'æŸ¥çœ‹èµ„æ–™', gzTxt, 'ä¸¾æŠ¥', 'æ‹‰é»‘'];
        // var keyArr = [1, 2, 3, 4, 5, 6]
        _action('', buttons, function(bIndex) {
            if (bIndex != (buttons.length + 1)) {
                var index = keyArr[bIndex - 1];
                switch (index) {
                    case 1:
                        _url({
                            url: 'frame2/beizhu',
                            title: 'è®¾ç½®å¤‡æ³¨å'
                        })
                        break;
                    case 2:
                        setMsgTop();
                        break;
                    case 3:
                        go_userInfo(view.touserid);
                        break;
                    case 4:
                        guanzhu()
                        break;
                    case 5:
                        _url({
                            url: 'frame0/ju_bao_frame',
                            title: 'åŒ¿åä¸¾æŠ¥',
                            uid: view.touserid
                        })
                        break;
                    case 6:
                        addBlack();
                        break;
                    default:
                        break;
                }
            }
        })
    }

    // æ‹‰é»‘
    function addBlack() {
        _addBlack(view.touserid, function(type) {
            view.info.blacklist = type;
        })
    }

    // å…³æ³¨
    function guanzhu() {
        _ajax('api/user/attention', function(ret, err) {
            _msg(ret.msg);
            if (ret && ret.code == 200) {
                if (ret.msg == 'å…³æ³¨æˆåŠŸ') {
                    view.info.attention = 1;
                } else {
                    view.info.attention = 0;
                }
                pushMsg(view.touserid);
            }
        }, {
            user_id: view.userid,
            to_user: view.touserid,
        })
    }
    // æ¶ˆæ¯ç½®é¡¶
    function setMsgTop() {

    }


    // å½•éŸ³å¼€å§‹
    function recordBegin() {
        if (view.record != 0) return;
        console.log('=======å½•éŸ³å¼€å§‹==========')
        var micResult = api.hasPermission({
            list: ['microphone', 'storage']
        });
        if (!micResult[0].granted) {
            getPermission(['microphone', 'storage'], function(code) {
                if (code != 0) {
                    _msg('è¯·å…ˆå¼€å¯ç›¸å…³æƒé™');
                }
            })
        } else {
            view.recordTxt = 'æ‰‹æŒ‡ä¸Šåˆ’ï¼Œå–æ¶ˆå‘é€';
            view.recordBtnTxt = 'æ¾å¼€ç»“æŸ';
            view.record = 1;
            recMp3.start();
        }
    }
    // å½•éŸ³å–æ¶ˆ
    function recordCancel() {
        if (view.record != 1) return;
        console.log('=======å½•éŸ³å–æ¶ˆ==========')
        view.recordTxt = 'å·²å–æ¶ˆ';
        view.recordBtnTxt = 'æŒ‰ä½è¯´è¯';
        view.record = 0;
        setTimeout(function() {
            recMp3.stop();
        }, 500)
    }
    // å½•éŸ³ç»“æŸ
    function recordEnd() {
        if (view.record != 1) return;
        console.log('=======å½•éŸ³ç»“æŸ==========')
        setTimeout(function() {
            view.recordBtnTxt = 'æŒ‰ä½è¯´è¯';
            recMp3.stop(function(ret) {
                console.log(JSON.stringify(ret))
                if (ret && ret.status) {
                    if (ret.duration) {
                        if (ret.duration < 1) {
                            view.recordTxt = 'å½•éŸ³æ—¶é—´å¤ªçŸ­';
                            setTimeout(function() {
                                view.record = 0;
                            }, 500)
                        } else {
                            view.record = 0;
                            var path = ret.path;
                            path = path.replace('fs://', api.fsDir + '/');
                            sendMsg({
                                type: 2,
                                second: ret.duration,
                                content: ret.path
                            })
                        }
                    } else {
                        view.recordTxt = 'å½•éŸ³æ—¶é—´å¤ªçŸ­';
                        setTimeout(function() {
                            view.record = 0;
                        }, 500)
                    }
                }
            });
        }, 500)
    }

    // å¿ƒåŠ¨
    function dashan() {
        _ajax('api/privatechat/greet', function(ret, err) {
            _msg(ret.msg);
        }, {
            user_id: view.userid,
            id: view.touserid,
        })
    }
</script>

</html>